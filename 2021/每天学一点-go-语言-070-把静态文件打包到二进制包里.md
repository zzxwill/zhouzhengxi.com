# 每天学一点-go-语言-070-把静态文件打包到二进制包里

Posted on Feb 8 2021

---

## 背景

下面目录下的 .tmpl 文件需要打包到二进制文件里，需要执行命令时，读取这些文件

```shell
➜  /Users/zhouzhengxi/Programming/golang/src/github.com/alibaba/derrick git:(golang) ✗ tree rigging
rigging
├── golang
│   ├── golang_rigging.go
│   └── templates
│       ├── Dockerfile.tmpl
│       ├── docker-compose.yml.tmpl
│       └── kubernetes-deployment.yaml.tmpl
├── maven
│   ├── maven_rigging.go
│   └── templates
│       ├── Dockerfile.j2
│       ├── Jenkinsfile.j2
│       ├── docker-compose.yml.j2
│       └── kubernetes-deployment.yaml.j2
├── nodejs
│   ├── nodejs_rigging.go
│   └── templates
│       ├── Dockerfile.tmpl
│       ├── docker-compose.yml.tmpl
│       └── kubernetes-deployment.yaml.tmpl
├── php
│   ├── php_rigging.go
│   └── templates
│       ├── Dockerfile.j2
│       ├── Jenkinsfile.j2
│       ├── docker-compose.yml.j2
│       └── kubernetes-deployment.yaml.j2
└── python
    ├── python_rigging.go
    └── templates
        ├── Dockerfile.j2
        ├── Jenkinsfile.j2
        ├── docker-compose.yml.j2
        └── kubernetes-deployment.yaml.j2

10 directories, 23 files
```

## 方案

[Pkger](https://github.com/markbates/pkger) 是个简单而酷的方案。


```makefile
embed-templates:
	go get github.com/markbates/pkger/cmd/pkger
	$(GOPATH)/bin/pkger -include /rigging
```

`-include` 表明该目录下面的文件会被存储。


Build 时一定要注意，`go build -o /usr/local/bin/derrick *.go` 不能像之前那样 `go build -o /usr/local/bin/derrick main.go`，否则只会
构建 main.go 和他的以来，要把 pkged.go 也打进去。

```makefile
all: build

build: embed-templates
	go build -o /usr/local/bin/derrick *.go
	rm -f pkged.go


embed-templates:
	go get github.com/markbates/pkger/cmd/pkger
	$(GOPATH)/bin/pkger -include /rigging
```

## 原理

在原来 os.walk 或文件读写地方，改成 `pkger` 库，这样 pkger 就会去找静态文件。
```go
func renderTemplates(rig common.Rigging, detectedContext map[string]string, destDir string) error {
	// TODO(zzxwill) PkgPath() returns github.com/alibaba/derrick/rigging/golang/templates
	// there might be a better solution get the direcotry of the templates
	pkgPath := strings.Join(strings.Split(reflect.TypeOf(rig).PkgPath(), "/")[3:], "/")
	absTemplateDir := filepath.Join("/", filepath.Clean(pkgPath))
	templateDir := filepath.Join(absTemplateDir, "templates")
	var templates []string
	err := pkger.Walk(absTemplateDir, func(path string, info os.FileInfo, err error) error {
		if info != nil && strings.HasSuffix(info.Name(), ".tmpl") {
			templates = append(templates, info.Name())
		}
		return nil
	})
	if err != nil {
		return err
	}
	for _, t := range templates {
		renderedTemplate, err := renderTemplate(templateDir, t, detectedContext)
		if err != nil {
			return err
		}
		renderedTemplateName := strings.Split(t, ".tmpl")
		if len(renderedTemplateName) != 2 {
			return fmt.Errorf("template %s is not in the right format", t)
		}
		if err := ioutil.WriteFile(filepath.Join(destDir, renderedTemplateName[0]), []byte(renderedTemplate), 0750); err != nil {
			return err
		}
	}
	return nil
}
```

`pkger -include` 会生成如下文件，上面读写文件，预计会根据下面字符串 unmarshall 出来。

```go
✗ cat pkged.go
// Code generated by pkger; DO NOT EDIT.

// +build !skippkger

package main

import (
	"github.com/markbates/pkger"
	"github.com/markbates/pkger/pkging/mem"
)

var _ = pkger.Apply(mem.UnmarshalEmbed([]byte(`1f8b08000000000000ffecbd6b73a2ccd63ffc5576f9f6993d694e2a5375bf10121134664
439deb56b17a720b1395c821adc757df7a7684051930c9998f967dfd53595419ad54d1f572fd6e1d7ffe904d1639c767efca7e307d972637f77e2f0c
682816dd9d68debadd781b32a9ede06ebce8fce8d927aebf466bf8c37fba517f9cfc1cdcf75ecafad300c22ffc68fa115f937e9dab979a3b46f1d31
4ce275f6d3ca969d1f6fbdf75b676a855ee74727b482a8f3ad731b3b9d1f9dceb7cec25afb5ed6ba42761035ca94e3b875d6ceb7cebd9539cbce8fffe
d7ceffceb5b679e59d0ebfcc8d61bafba913d2b8da3ce8f4e5adcfdc3f5122f72bdc8c97ffce3f5a6dd38a1dbf9d611e26100bdb428bd68e2773f2ede
51760f4afd4509fffad6b9f51244696f1e83b8f3ad63e7999776be759c384cd65e9ade3c422bf39a09fe3e48d07d945941e4ad6f6090665582f78c7e
adf3248b0f3f6eacb2c4f2c60992a5b73edebbcd876e6a1d6f3ce7f4d6251986602f126e8228f3d691056f3c7767adddf49c0cc220c902e798b20cad
c6dd21fbda8adc4d16c0171ea51b3b83def141e832c79b225fe3cea11b37cd06a44b8b38b92399eec93d43908dfbb35766b0d14fcf0c604fef6e9255
f0dcf9d671adccb2add4bb49ff8237ee3ad8a2bef622277603341feb9f37561a11cdfb2217459ea774e9939420b2d67933c549b7cddba5f7dcbc7d2a
a676e33ef1c2e276bd8ed7456b1ea15554e9312c664d63ae0ea0e70c82adb50fd29b74b3de7af9cd966c4172e3c46baf0d5de6adc320b2e029edbd95
12a7913`)))
```